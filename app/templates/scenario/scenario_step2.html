{% extends 'scenario/scenario_progression.html' %}
{% load static %}
{% load crispy_forms_tags %}
{% load custom_filters %}
{% load i18n %}


{% block head_block %}
<link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/jerosoler/Drawflow/dist/drawflow.min.css">
<script src="https://cdnjs.cloudflare.com/ajax/libs/plotly.js/2.20.0/plotly.min.js" integrity="sha512-tuzZby9zsxdCMgqKMHo+ObEWrfBTFlKZ7yIHSow5IYbr0JseLNTXm37NSn0rrWVbvKMfvGUCSm5L1sK9QGuLyw==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
<!--<script src="{% static 'js/plotly.min.js' %}"></script>-->
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.1/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-+0n0xVW2eSR5OomGNYDnhzAbDsOXxcvSN1TPprVMTNDbiYZCxYbOOl7+AMvyTG2x" crossorigin="anonymous">
<link rel="stylesheet" type="text/css" href="{% static 'css/quick_fix.css' %}"/>
<link rel="stylesheet" type="text/css" href="{% static 'css/editor.css' %}"/>
{% endblock head_block %}


{% block start_body_scripts %}
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery-csv/1.0.21/jquery.csv.min.js" integrity="sha512-Y8iWYJDo6HiTo5xtml1g4QqHtl/PO1w+dmUpQfQSOTqKNsMhExfyPN2ncNAe9JuJUSKzwK/b6oaNPop4MXzkwg==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/d3/7.1.1/d3.min.js" integrity="sha512-COTaPOlz12cG4fSfcBsxZsjauBAyldqp+8FQUM/dZHm+ts/jR4AFoJhCqxy8K10Jrf3pojfsbq7fAPTb1XaVkg==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
<script type="text/javascript" src="https://unpkg.com/xlsx/dist/xlsx.full.min.js"></script>
<script src="{% static 'js/traceplot.js' %}"></script>

<!--
<link rel="stylesheet" type="text/css" href="{% static 'css/beautiful1.css' %}"/>


<link rel="stylesheet" type="text/css" href="{% static 'css/main.css' %}"/>
-->
{% endblock start_body_scripts %}


<!-- WRITE HTML CODE WITHIN THESE block content TAGS -->
{% block progression_content %}


<!-- Modal -->

<div class="modal fade modal--gui" id="guiModal" tabindex="-1" role="dialog" aria-labelledby="guiModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="guiModalLabel">New message</h5>
                <button type="button" class="close" data-bs-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
                <div class="container">
                    <div class="row align-item-start">
                        <div class="col">
                            <form id="assetForm">
                                {% csrf_token %}
                                <div class="modal-body">
                                </div>
                            </form>
                        </div>
                    </div>
                    <div class="row collapse modal-body" id="form-computeCOP">
                        <div class="col"></div>
                        <div class="col">
                            <form id="copForm">
                                {% csrf_token %}
                                <div class="modal-addendum"></div>
                            </form>
                            <button
                                id="btn-computeCOP"
                                class="btn btn--medium"
                                onclick="computeCOP(event)">
                                {% translate "compute COP" %}
                            </button>
                        </div>
                    </div>
                </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">{% translate "Close" %}</button>
                {% if user_has_right_to_save %}
                <button class="btn btn--medium" onclick="submitForm(event)">{% translate "Save" %}</button>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<main>
    <section class="system-design">
        <div class="components">
            <div class="components__title">
                <div>
                    <h2>{% translate "Energy components" %}</h2>
                    <span class="icon icon-question" data-bs-toggle="tooltip" title="Lorem ipsum"></span>
                </div>
            </div>

            <div class="components__content">
                {% for group_name, group_components in components.items %}
                    <div class="section section--{{ group_name }}">
                        <div class="section__title">
                            <h3>{{ group_names|get_item:group_name|title }}</h3>
                        </div>
                        {% for component_id, component_name in group_components.items %}
                            {% include 'scenario/topology_drag_items.html' with name=component_name alt=component_name|add:" icon" image=component_id|add:".svg" data_node=component_id %}
                        {% endfor %}
                    </div>
                {% endfor %}
            </div>
        </div>
        <div id="drawflow" class="gui" ondrop="drop(event)" ondragover="allowDrop(event)">
            <div class="gui__clear">
                <div id="area-selection-div" hidden style="border: 1px dotted #000; position: absolute;"></div>
                <!--div class="load-scenario">
                    <select class="form-select">
                        <option selected>{% translate "Load system design from existing scenario" %}</option>
                        <option value="1">PV Potsdam 2025</option>
                        <option value="2">open_plan test</option>
                    </select>
                </div-->
                <!--a class="btn btn--small btn--hollow" onclick="clearGridModel()">{% translate "Clear design" %}</a-->
            </div>
            <!--<div class="gui__empty-text">
                <span>{% translate "Drag and drop components to build your energy system" %}</span>
            </div>-->
        </div>
    </section>
</main>
{% endblock progression_content %}


{% block end_body_scripts %}
<script src="https://cdn.jsdelivr.net/gh/jerosoler/Drawflow/dist/drawflow.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@10"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery.serializeJSON/3.1.0/jquery.serializejson.min.js"
        integrity="sha512-4y8bsEzrXJqRyl2dqjdKk/DetH59JcFTtYNMsy5DUpvVV8CXiSrQ1gSCL3+dFgj1Xco0ONPizsYd6wX2eAXL2g=="
        crossorigin="anonymous"></script>
<script src="https://code.jquery.com/ui/1.12.1/jquery-ui.js"></script>

<script>
    const csrfToken = '{{ csrf_token }}';
    const formGetUrl = `{% url 'get_asset_create_form' scenario.id %}`;
    const formPostUrl = `{% url 'asset_create_or_update' scenario.id %}`;
    const scenarioBelongsToUser = {% if scenario.project.user == request.user %}true{% else %}false{% endif %};
    const copGetUrl = `{% url 'get_asset_cops_form' scenario.id %}`;
    const copPostUrl = `{% url 'asset_cops_create_or_update' scenario.id %}`;
    const tsGetUrl = `{% url 'get_timeseries' %}`;
    const findtsGetUrl = `{% url 'get_constant_timeseries_id' %}`;
</script>
<script src="{% static 'js/grid_model_topology.js' %}"></script>

<script>
    // activate the double click function provided in grid_model_topology
    document.querySelector('.drawflow').addEventListener("dblclick", dblClick);

    /* First retrieve the busses and assets, then draw the links */
    $(window).on('load', async function () {
        const data = JSON.parse(`{{topology_data_list| escapejs }}`);
        Promise.all([addBusses(data['busses']), addAssets(data['assets'])])
            .then(async () => addLinks(data['links']))
            .then(() => zoomToFit())
            .then(() => changeOrderOfClasses())
            .then(() => {
                // disable save button (populating editor may have enabled button)
                document.getElementById('btn-save')?.classList.add('disabled');
            })
            .catch(err=>{
                    console.error(err);
                    Swal.fire('Grid Model Error', 'Could not retrieve grid nodes.', 'error');
            });
    });
    window.changeOrderOfClasses = function() {
        const drawflowDiv = document.getElementById('drawflow');
        const classes = Array.from(drawflowDiv.classList);
        const parentIndex = classes.indexOf('parent-drawflow');
        if (parentIndex > -1) {
            classes.splice(parentIndex, 1);
            classes.unshift('parent-drawflow');
        }
        drawflowDiv.className = classes.join(' ');
    }
</script>

<script defer>
    $(document).ready(function () {
        disabled_assets = [];//["gas_dso", "h2_dso", "biogas_plant", "geothermal_conversion", "diesel_generator", "fuel_cell", "gas_boiler", "electrolyzer", "hess"];
        disabled_assets.forEach(asset_name => {document.querySelector(`[data-node='${asset_name}']`).classList.add("greyed_out"); document.querySelector(`[data-node='${asset_name}']`).setAttribute("title", "This is disabled")});
    });
    function clearGridModel() {
        Swal.fire({
            title: "Are you sure?",
            text: "This will clear the whole grid model! This will not actually delete any asset from the scenario. You will need to save after clearing for the changes to actually take effect.",
            icon: "warning",
            showCancelButton: true,
            confirmButtonText: "Yes, clear everything!",
            cancelButtonText: "Cancel",
        }).then((result) => result.value && editor.clearModuleSelected());
    }

    function move_step(){
        window.location.href = "{% url 'scenario_create_constraints' proj_id scen_id %}";
    };

    /*
     * Export Topology to JSON and send to back-end.
     * Used by the Save and Next buttons at page footer
    */
    function save_topology(move_step=false) {
        // Data Pre-check
        const save_button = document.getElementById('btn-save');
        const save_spinner = document.getElementById('saveSpinner');
        const save_toast = document.getElementById('saveToast');
        const editorData = editor.export().drawflow.Home.data;
        const node_list = Object.values(editorData)
        const node_names = node_list.map(obj => obj.data.name);
        // warn in case of empty model
        if (node_list.length == 0 && !confirm('No components in model. Continue?'))
            return;
        // Check if there are duplicate node names in the model
        // and prevent user from saving the model if there are.
        // Might also be handled in backend when saving names.
        const duplicate_names = node_names.filter((name, i, a) => a.indexOf(name) !== i);
        if (duplicate_names.length != 0) {
            alert('There are nodes with duplicate names.\nRename nodes with names: ' + duplicate_names.toString());
            return;
        }
        // Check for nodes to in nodesToDB
        // A missing entry usually stems from missing values and blocks creation of drawflowData
        const nodesNotInDB = node_list.filter(node => !nodesToDB.has('node-'+node.id));
        if (nodesNotInDB.length) {
            alert('There are components not saved yet:\n' + nodesNotInDB.map(node => node.data.name).join(', ') + '\nPlease click on them and save them to fix this error (it might be possible that some arguments are missing).');
            return;
        }

        // (temporarily) disable save button
        save_button.classList.add('disabled');
        save_spinner.classList.remove('d-none');

        try {
            const transformIOs = (obj, entry) => {
                const [key, io] = entry;
                obj[key] = io.connections.map(conn => {
                    let value = { node: nodesToDB.get('node-' + conn.node).uid};
                    if ('output' in conn)
                        value.output = conn.output;
                    else
                        value.input = conn.input;
                    return value;
                });
                return obj;
            }
            const drawflowData = node_list.map(obj=>({
                db_id: nodesToDB.get('node-'+obj.id).uid,
                name: obj.name,
                inputs: Object.entries(obj.inputs).reduce(transformIOs, {}),
                outputs: Object.entries(obj.outputs).reduce(transformIOs, {}),
                data: obj.data,
                pos_x: obj.pos_x,
                pos_y: obj.pos_y,
            }));

            fetch("{% url 'scenario_create_topology' proj_id scenario.id %}", {
                method: 'POST',
                headers: {
                    'X-CSRFToken': '{{ csrf_token }}',
                    'Content-Type': 'application/json; charset=utf-8',
                    'Accept': 'application/json',
                },
                body: JSON.stringify(drawflowData),
            }).then(_ => {
                // success: may move to next step
                save_spinner.classList.add('d-none');
                save_toast.classList.remove('d-none');
                save_toast.classList.add('show');
                setTimeout(() => {
                    save_toast.classList.remove('show');
                    save_toast.classList.add('d-none');
                }, 3000);

                 if (move_step){
                    window.location.href = "{% url 'scenario_create_constraints' proj_id scen_id %}";
                }
                // save button should still be disabled until next change
            }).catch(error => {
                save_spinner.classList.add('d-none');
                save_button.disabled = false;
                error.json().then(jsonData => {
                    if (jsonData.specific_obj_type) {
                        Swal.fire('Grid Model Error', `Please fill in all ${jsonData.specific_obj_type.bold()} fields. \n
                        Asset ${jsonData.obj_name.bold()} has empty fields or fields with wrong values.`, 'error');
                        console.log(jsonData.full_error);
                    } else {
                        Swal.fire('Grid Model Error', `Asset ${jsonData.obj_name.bold()} has empty fields or fields with wrong values.`, 'error');
                    }
                }).catch(_ => {
                    console.error(error);
                });
                // re-enable save button
                save_button.classList.remove('disabled');
            });
        } catch (error) {
            console.error('Error while saving topology. ' + error);
            // re-enable save button
            save_button.classList.remove('disabled');
            save_spinner.classList.add('d-none');
            save_button.disabled = false;
            return Swal.fire('Grid Model Error',
                'There are empty assets.\n Make sure all assets are filled in with data.', 'error');
        }
        // add feedback message to save button


        save_button.addEventListener('click', () => {
        save_button.disabled = true;
        save_spinner.classList.remove('d-none');

        // Simulate save delay
        setTimeout(() => {
            save_spinner.classList.add('d-none');
            save_button.disabled = false;

            // Show toast
            save_toast.classList.remove('d-none');
            save_toast.classList.add('show');

            // Auto-hide
            setTimeout(() => {
            save_toast.classList.remove('show');
            save_toast.classList.add('d-none');
            }, 3000);
        }, 1500);
        });
    }
</script>
{% endblock end_body_scripts %}

{% block footer %}
<!-- Toast container (above footer) -->
<div class="custom-toast-container">
    <div id="saveToast"
        class="toast align-items-center text-bg-success border-0 d-none"
        role="alert">
        <div class="d-flex">
            <div class="toast-body">
                <svg width="16" height="16" version="1.1" viewBox="0 0 100 100" fill="#1F567D" xmlns="http://www.w3.org/2000/svg">
                    <path d="m65.691 35.762-21.68 21.668-9.6992-9.6992c-1.25-1.25-3.2891-1.25-4.5391 0s-1.25 3.2891 0 4.5391l11.969 11.969c0.62891 0.62891 1.4492 0.94141 2.2695 0.94141 0.82031 0 1.6406-0.30859 2.2695-0.94141l23.949-23.938c1.25-1.25 1.25-3.2891 0-4.5391-1.2617-1.2617-3.2891-1.2617-4.5391 0z"/>
                    <path d="m50 10c-22.059 0-40 17.941-40 40s17.941 40 40 40 40-17.941 40-40-17.941-40-40-40zm0 73.578c-18.512 0-33.578-15.059-33.578-33.578s15.066-33.578 33.578-33.578 33.578 15.059 33.578 33.578-15.066 33.578-33.578 33.578z"/>
                </svg>
                <span>Saved successfully</span>
            </div>
        </div>
    </div>
</div>

<footer class="step-footer">
  <div>
    <div class="step-footer__left"></div>
    <div class="step-footer__center">
        <a class="btn btn--medium btn--hollow btn--previous" href="{% url 'scenario_steps_edit' proj_id scen_id step_id|add:'-1' %}" aria-disabled="true">{% translate "Previous" %}</a>
        {% if user_has_right_to_save %}
            <button
                onclick="javascript:save_topology(move_step=true)"
                id="next_btn" class="btn btn--medium" >
                {% translate "Next" %}
            </button>
        {% else %}
            <button
                onclick="javascript:move_step()"
                id="next_btn"
                class="btn btn--medium" >
                {% translate "Next" %}
            </button>
        {% endif %}
        {% if scen_id and existing_simulation %}
            <a
                class="btn btn--medium btn--transparent"
                href="{% url 'scenario_steps_edit' proj_id scen_id max_step|add:'-1' %}">
                {% translate "Go to simulation" %}
            </a>
        {% endif %}
    </div>
    <div class="step-footer__right">
        {% if user_has_right_to_save %}
            <button
                id="btn-save"
                class="btn btn--medium btn--transparent disabled"
                onclick="javascript:save_topology()">
                <span id="saveSpinner" class="spinner-border spinner-border-sm me-2 d-none" role="status" aria-hidden="true"></span>
                {% translate "Save" %}
            </button>
        {% endif %}
    </div>
  </div>
</footer>
{% endblock footer %}
